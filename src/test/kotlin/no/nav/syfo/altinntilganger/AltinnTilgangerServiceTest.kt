package no.nav.syfo.altinntilganger

import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.module.kotlin.jacksonObjectMapper
import com.fasterxml.jackson.module.kotlin.readValue
import io.kotest.assertions.throwables.shouldNotThrow
import io.kotest.assertions.throwables.shouldThrow
import io.kotest.core.spec.style.DescribeSpec
import io.kotest.matchers.shouldBe
import io.mockk.clearAllMocks
import io.mockk.coEvery
import io.mockk.mockk
import no.nav.syfo.altinntilganger.client.AltinnTilgangerResponse
import no.nav.syfo.altinntilganger.client.FakeAltinnTilgangerClient
import no.nav.syfo.application.auth.UserPrincipal
import no.nav.syfo.application.exception.ApiErrorException
import no.nav.syfo.application.exception.UpstreamRequestException
import org.apache.kafka.shaded.com.google.protobuf.Api

class AltinnTilgangerServiceTest : DescribeSpec({
    val altinnTilgangerClient = FakeAltinnTilgangerClient()
    val altinnTilgangerService = AltinnTilgangerService(altinnTilgangerClient)

    beforeTest {
        clearAllMocks()
    }

    describe("validateTilgangToOrganization") {
        it("should not throw when user has access to org") {
            val fnr = "12345678901"
            val orgnummer = "987654321"
            val userPrincipal = UserPrincipal(fnr, "token")
            shouldThrow<ApiErrorException.ForbiddenException> {
                altinnTilgangerService.validateTilgangToOrganization(userPrincipal, orgnummer)
            }
        }

        it("should throw Forbidden when user lacks access to org") {
            val accessPair = altinnTilgangerClient.usersWithAccess.first()
            val userPrincipal = UserPrincipal(accessPair.first, "token")
            shouldThrow<ApiErrorException.ForbiddenException> {
                altinnTilgangerService.validateTilgangToOrganization(userPrincipal, accessPair.second)
            }
        }

        it("should throw =Internal Server Error when client fails to make request") {
            val mockAltinnTilgangerClient = mockk<FakeAltinnTilgangerClient>()
            coEvery { mockAltinnTilgangerClient.fetchAltinnTilganger(any())} throws UpstreamRequestException("Forced failure")
            val altinnTilgangerServiceWithMock = AltinnTilgangerService(mockAltinnTilgangerClient)
            val accessPair = altinnTilgangerClient.usersWithAccess.first()
            val userPrincipal = UserPrincipal(accessPair.first, "token")
            shouldThrow<ApiErrorException.InternalServerErrorException> {
                altinnTilgangerServiceWithMock.validateTilgangToOrganization(userPrincipal, accessPair.second)
            }
        }
        it("should return the organization with access for the provided orgnumber") {
            val hierarchyString = """{"hierarki":[{"orgnr":"310667633","altinn3Tilganger":["nav_rekruttering_stillingsannonser","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","nav_syfo_oppfolgingsplan","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","nav_sosialtjenester_digisos-avtale"],"altinn2Tilganger":["3403:1","5332:1","5867:1","5810:1","4936:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","5441:2","5516:5","5516:6","4596:1","2896:87","5441:1","4826:1","5902:1","5078:1","5278:1"],"underenheter":[{"orgnr":"215649202","altinn3Tilganger":["nav_rekruttering_stillingsannonser","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","nav_syfo_oppfolgingsplan","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","nav_sosialtjenester_digisos-avtale"],"altinn2Tilganger":["3403:1","5332:1","5867:1","5810:1","4936:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","5441:2","5516:5","5516:6","4596:1","2896:87","5441:1","4826:1","5902:1","5078:1","5278:1"],"underenheter":[],"navn":"KONTANT PRAGMATISK FJELLREV","organisasjonsform":"BEDR"},{"orgnr":"315649188","altinn3Tilganger":["nav_rekruttering_stillingsannonser","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","nav_syfo_oppfolgingsplan","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","nav_sosialtjenester_digisos-avtale"],"altinn2Tilganger":["3403:1","5332:1","5867:1","5810:1","4936:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","5441:2","5516:5","5516:6","4596:1","2896:87","5441:1","4826:1","5902:1","5078:1","5278:1"],"underenheter":[],"navn":"OPPGITT SMIDIG FJELLREV","organisasjonsform":"BEDR"},{"orgnr":"315649196","altinn3Tilganger":["nav_rekruttering_stillingsannonser","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","nav_syfo_oppfolgingsplan","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","nav_sosialtjenester_digisos-avtale"],"altinn2Tilganger":["3403:1","5332:1","5867:1","5810:1","4936:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","5441:2","5516:5","5516:6","4596:1","2896:87","5441:1","4826:1","5902:1","5078:1","5278:1"],"underenheter":[],"navn":"STABIL GLUPSK FJELLREV","organisasjonsform":"BEDR"},{"orgnr":"315649218","altinn3Tilganger":["nav_rekruttering_stillingsannonser","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","nav_syfo_oppfolgingsplan","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","nav_sosialtjenester_digisos-avtale"],"altinn2Tilganger":["3403:1","5332:1","5867:1","5810:1","4936:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","5441:2","5516:5","5516:6","4596:1","2896:87","5441:1","4826:1","5902:1","5078:1","5278:1"],"underenheter":[],"navn":"SIVILISERT GØYAL FJELLREV","organisasjonsform":"BEDR"}],"navn":"VENSTRE ROMANTISK TIGER AS","organisasjonsform":"AS"},{"orgnr":"910073710","altinn3Tilganger":["nav_syfo_dialog"],"altinn2Tilganger":[],"underenheter":[],"navn":"EIDSVÅGNESET OG LANGØY GRUVER","organisasjonsform":"AS"}],"orgNrTilTilganger":{"310667633":["nav_rekruttering_stillingsannonser","5867:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","4596:1","4826:1","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","5078:1","3403:1","5332:1","5810:1","4936:1","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","5441:2","5516:5","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","5516:6","nav_syfo_oppfolgingsplan","2896:87","5441:1","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","5902:1","5278:1","nav_sosialtjenester_digisos-avtale"],"215649202":["nav_rekruttering_stillingsannonser","5867:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","4596:1","4826:1","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","5078:1","3403:1","5332:1","5810:1","4936:1","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","5441:2","5516:5","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","5516:6","nav_syfo_oppfolgingsplan","2896:87","5441:1","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","5902:1","5278:1","nav_sosialtjenester_digisos-avtale"],"315649188":["nav_rekruttering_stillingsannonser","5867:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","4596:1","4826:1","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","5078:1","3403:1","5332:1","5810:1","4936:1","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","5441:2","5516:5","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","5516:6","nav_syfo_oppfolgingsplan","2896:87","5441:1","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","5902:1","5278:1","nav_sosialtjenester_digisos-avtale"],"315649196":["nav_rekruttering_stillingsannonser","5867:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","4596:1","4826:1","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","5078:1","3403:1","5332:1","5810:1","4936:1","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","5441:2","5516:5","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","5516:6","nav_syfo_oppfolgingsplan","2896:87","5441:1","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","5902:1","5278:1","nav_sosialtjenester_digisos-avtale"],"315649218":["nav_rekruttering_stillingsannonser","5867:1","5384:1","5516:3","5516:4","5719:1","5516:1","5516:2","4596:1","4826:1","nav_arbeidsforhold_aa-registeret-sok-tilgang","nav_syfo_oppgi-narmesteleder","nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk","nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger","nav_arbeidsforhold_aa-registeret-brukerstotte","5078:1","3403:1","5332:1","5810:1","4936:1","test-fager","nav_syfo_dialogmote","nav_foreldrepenger_inntektsmelding","nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver","nav_tiltak_tiltaksrefusjon","5441:2","5516:5","nav_forebygge-og-redusere-sykefravar_ia-samarbeid","5516:6","nav_syfo_oppfolgingsplan","2896:87","5441:1","nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver","5902:1","5278:1","nav_sosialtjenester_digisos-avtale"],"910073710":["nav_syfo_dialog"]},"tilgangTilOrgNr":{"5078:1":["215649202","315649218","315649196","310667633","315649188"],"5810:1":["215649202","315649218","315649196","310667633","315649188"],"5867:1":["215649202","315649218","315649196","310667633","315649188"],"2896:87":["215649202","315649218","315649196","310667633","315649188"],"5441:1":["215649202","315649218","315649196","310667633","315649188"],"5441:2":["215649202","315649218","315649196","310667633","315649188"],"5719:1":["215649202","315649218","315649196","310667633","315649188"],"3403:1":["215649202","315649218","315649196","310667633","315649188"],"4826:1":["215649202","315649218","315649196","310667633","315649188"],"4936:1":["215649202","315649218","315649196","310667633","315649188"],"5278:1":["215649202","315649218","315649196","310667633","315649188"],"5332:1":["215649202","315649218","315649196","310667633","315649188"],"5384:1":["215649202","315649218","315649196","310667633","315649188"],"5516:1":["215649202","315649218","315649196","310667633","315649188"],"5516:2":["215649202","315649218","315649196","310667633","315649188"],"5516:3":["215649202","315649218","315649196","310667633","315649188"],"5516:4":["215649202","315649218","315649196","310667633","315649188"],"5516:5":["215649202","315649218","315649196","310667633","315649188"],"5516:6":["215649202","315649218","315649196","310667633","315649188"],"5902:1":["215649202","315649218","315649196","310667633","315649188"],"4596:1":["215649202","315649218","315649196","310667633","315649188"],"test-fager":["215649202","315649218","315649196","310667633","315649188"],"nav_rekruttering_stillingsannonser":["215649202","315649218","315649196","310667633","315649188"],"nav_permittering-og-nedbemmaning_innsyn-i-alle-innsendte-meldinger":["215649202","315649218","315649196","310667633","315649188"],"nav_sosialtjenester_digisos-avtale":["215649202","315649218","315649196","310667633","315649188"],"nav_utbetaling_endre-kontonummer-refusjon-arbeidsgiver":["215649202","315649218","315649196","310667633","315649188"],"nav_arbeidsforhold_aa-registeret-innsyn-arbeidsgiver":["215649202","315649218","315649196","310667633","315649188"],"nav_arbeidsforhold_aa-registeret-brukerstotte":["215649202","315649218","315649196","310667633","315649188"],"nav_arbeidsforhold_aa-registeret-sok-tilgang":["215649202","315649218","315649196","310667633","315649188"],"nav_syfo_dialogmote":["215649202","315649218","315649196","310667633","315649188"],"nav_syfo_oppfolgingsplan":["215649202","315649218","315649196","310667633","315649188"],"nav_syfo_oppgi-narmesteleder":["215649202","315649218","315649196","310667633","315649188"],"nav_forebygge-og-redusere-sykefravar_ia-samarbeid":["215649202","315649218","315649196","310667633","315649188"],"nav_tiltak_tiltaksrefusjon":["215649202","315649218","315649196","310667633","315649188"],"nav_foreldrepenger_inntektsmelding":["215649202","315649218","315649196","310667633","315649188"],"nav_forebygge-og-redusere-sykefravar_sykefravarsstatistikk":["215649202","315649218","315649196","310667633","315649188"],"nav_syfo_dialog":["910073710"]},"error":false}"""
            val objectMapper = jacksonObjectMapper()
            val tilgangerResponse = objectMapper.readValue<AltinnTilgangerResponse>(hierarchyString)
            val mockAltinnTilgangerClient = mockk<FakeAltinnTilgangerClient>()
            coEvery { mockAltinnTilgangerClient.fetchAltinnTilganger(any())} returns tilgangerResponse

            val accessPair = altinnTilgangerClient.usersWithAccess.first()
            val userPrincipal = UserPrincipal(accessPair.first, "token")
            val altinnTilgangerServiceWithMock = AltinnTilgangerService(mockAltinnTilgangerClient)
            val org = altinnTilgangerServiceWithMock.validateTilgangToOrganization(userPrincipal, "310667633")
//            val flat = tilgangerResponse.hierarki.flatMap { it.underenheter }
            tilgangerResponse.hierarki.size shouldBe 2
        }
    }
})
