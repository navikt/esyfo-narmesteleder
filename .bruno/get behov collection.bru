meta {
  name: get behov collection
  type: http
  seq: 3
}

get {
  url: {{baseUrlEkstern}}/api/v1/linemanager/requirement?orgNumber=311315293&createdAfter=2025-09-08T11:55:24Z&pageSize=5
  body: none
  auth: bearer
}

params:query {
  orgNumber: 311315293
  createdAfter: 2025-09-08T11:55:24Z
  pageSize: 5
}

auth:bearer {
  token: eyJraWQiOiJhYTU1OGUzYi0zYTYxLTQxMDQtYjk4Ni01YTQ5NDEwYjA2M2UiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiIxMTkxNjM5ODU1OSIsImlzcyI6Imh0dHBzOi8vdG9rZW54LmRldi1nY3AubmF2LmNsb3VkLm5haXMuaW8iLCJjbGllbnRfYW1yIjoicHJpdmF0ZV9rZXlfand0IiwicGlkIjoiMTE5MTYzOTg1NTkiLCJjbGllbnRfaWQiOiJkZXYtZ2NwOm5haXM6dG9rZW54LXRva2VuLWdlbmVyYXRvciIsImF1ZCI6ImRldi1nY3A6dGVhbS1lc3lmbzplc3lmby1uYXJtZXN0ZWxlZGVyIiwiYWNyIjoiTGV2ZWw0IiwibmJmIjoxNzY1Mzc2MjU5LCJpZHAiOiJodHRwczovL3Rlc3QuaWRwb3J0ZW4ubm8iLCJzY29wZSI6Im9wZW5pZCIsImV4cCI6MTc2NTM3OTg1OSwiaWF0IjoxNzY1Mzc2MjU5LCJqdGkiOiI5ZDYwZTFjMC05OWJiLTRiYTQtODMzNS0wMWRiNzBmN2Q0ZDciLCJjb25zdW1lciI6eyJhdXRob3JpdHkiOiJpc282NTIzLWFjdG9yaWQtdXBpcyIsIklEIjoiMDE5Mjo4ODk2NDA3ODIifX0.qWH0tQCcrqI6up4XBLHgJxlVZwQHT2IHur1QoB5uM1EtfFW_y_9pwd8HioQzd89vHVfeMcvhwkVseh2hCtHLHRt77hLt2Td_Ls5lVmuL7J-lN5p5ZS6DvTNO1z-RsQny71S60WgQn_eZmw2ye2yM6my96kfLI9IUSiZgRchrL6EgC1Q6LhD-39a5KcQb1VpFoQJQ9PfjtJ3uIKcFqGTCyWa8_ZvBufxRJMltmwnYyzXi7pL5ieOqkpUnPo1d2uYunX1VDijFuZw1xdOJWybD5WUHdKT9w9AdKYDtwOvqfpsPA4GcgvxmGcXFioXQLxJWJGLPW4NNlFyuS8NfVJshlQ
}

assert {
  res.status: eq 200
}

script:pre-request {
  const http = require("axios");
  
  if (bru.getEnvName() === "nl_vars_local") {
    if (!bru.hasEnvVar("token")) {
      throw new Error("Kjør request 'mock maskinporten token' først for å teste lokalt");
    }
  } else {
    const systembrukerOrgnr = bru.getEnvVar("systemKundeOrgnr");
    const tokenrespons = await http.get("https://esyfo-token.intern.dev.nav.no/systembruker/" + systembrukerOrgnr + "?scope=nav%3Asyfo%2Fnarmesteleder%2Flps");
    console.log(tokenrespons.data);
    req.setHeader("Authorization", "Bearer "+ tokenrespons.data);
  }
}

script:post-response {
  const body = res.getBody();
  
  if (body != null) {
    bru.setVar("currentId",body.id);
  } 
}

settings {
  encodeUrl: true
  timeout: 0
}

docs {
  In order to create the :id for behov in this GET and the following PUT reques:
  1. Publish the following content in the kafka topic: ```teamsykmelding.syfo-narmesteleder-leesah```
      ```json
      {
        "narmesteLederId": "0199b8f1-0cfe-7787-bab8-2fb1cf1b4767",
        "fnr": "15436803416",
        "orgnummer": "215649202",
        "narmesteLederFnr": "215649202",
        "narmesteLederTelefonnummer": "12346532",
        "narmesteLederEpost": "e@post.no",
        "arbeidsgiverForskutterer": "false",
        "aktivFom": "2025-10-06",
        "aktivTom": "2025-10-06",
        "timestamp": "2025-10-06T11:50:52.433859Z",
        "status": "DEAKTIVERT_ARBEIDSTAKER"
      }
      ```
  1. Inspect the logs from the running ```esyfo-narmesteleder``` service and copy the UUID from the log line ```Inserted nærmeste leder-behov with id:```
  1. Create a file ```.env``` in the root folder of this collection, based on the existing ```.env.default```, and set the id in the proverty BEHOV_ID.
}
